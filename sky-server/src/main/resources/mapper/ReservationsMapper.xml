<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.sky.mapper.ReservationsMapper">
    <!-- 查找所有active并且结束时间已经过去的预约 -->
    <select id="findTime" parameterType="java.time.LocalDateTime" resultType="com.sky.entity.Reservations">
        SELECT *
        FROM parking.reservations
        WHERE status = 'active'
          AND end_time &lt; #{now}
    </select>

    <!-- 插入预约记录 -->
    <insert id="createReservations" parameterType="Reservations">
        INSERT INTO parking.reservations (user_id, parking_lot_id, space_id, start_time, end_time, total_fee, status)
        VALUES (#{userId}, #{parkingLotId}, #{spaceId}, #{startTime}, #{endTime}, #{totalFee}, #{status})
    </insert>



    <!-- 根据 phoneNumber 查询所有预约记录 -->
    <select id="selectReservation" parameterType="com.sky.dto.ReservationsPageQueryDTO" resultType="com.sky.vo.ReservationVO">
        SELECT
        r.reservation_id AS reservationId,
        u.username,
        u.phone_number AS phoneNumber,
        p.name,
        p.location,
        r.space_id AS spaceId,
        r.start_time AS startTime,
        r.end_time AS endTime,
        r.total_fee AS totalFee,
        r.status
        FROM parking.reservations r
        JOIN parking.users u ON r.user_id = u.user_id
        JOIN parking.parkinglots p ON r.parking_lot_id = p.parking_lot_id
        <where>
            <!-- 根据手机号码筛选 -->
            <if test="phoneNumber != null and phoneNumber != ''">
                AND u.phone_number = #{phoneNumber}
            </if>
        </where>
    </select>




    <!-- 更新预约状态 -->
    <update id="updateReservation" parameterType="com.sky.dto.UpdateReservationsDTO">
        UPDATE parking.reservations
        <set>
            <if test="parkingLotId != null">
                parking_lot_id = #{parkingLotId},
            </if>
            <if test="spaceId != null">
                space_id = #{spaceId},
            </if>
            <if test="startTime != null">
                start_time = #{startTime},
            </if>
            <if test="endTime != null">
                end_time = #{endTime},
            </if>
            <if test="status != null">
                status = #{status},
            </if>
        </set>
        WHERE reservation_id = #{reservationId}
    </update>


    <!-- 删除预约记录 -->
    <delete id="deleteReservation" parameterType="int">
        DELETE FROM parking.reservations WHERE reservation_id = #{reservationId}
    </delete>

</mapper>
