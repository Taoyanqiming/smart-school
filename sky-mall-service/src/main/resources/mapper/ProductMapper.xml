<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sky.mapper.ProductMapper">

    <!-- 分页查询 -->
    <select id="pageQuery" resultType="com.sky.entity.Product"
            parameterType="com.sky.dto.ProductPageQueryDTO">
        SELECT
        product_id,
        product_name,
        product_price,
        product_stock,
        product_limit,
        product_image_url
        FROM school.products
        <where>
            <if test="productName != null and productName != ''">
                AND product_name LIKE CONCAT('%', #{productName}, '%')
            </if>
        </where>
        <!-- PageHelper 自动处理分页参数 -->
    </select>

    <!-- 根据商品ID查询 -->
    <select id="getProductById" resultMap="com.sky.entity.Product"
            parameterType="java.lang.Integer">
        SELECT * FROM school.products
        WHERE product_id = #{productId}
    </select>

    <!-- 扣减库存（乐观锁示例：通过库存版本号或直接更新库存） -->
    <update id="decreaseProductStock">
        UPDATE school.products
        SET product_stock = product_stock + #{quantity}
        WHERE product_id = #{productId}
    </update>

    <!-- 插入普通商品（使用自增主键回填） -->
    <insert id="insert" parameterType="com.sky.entity.Product">
        INSERT INTO products
        (product_name, product_price, product_stock, product_limit, product_image_url)
        VALUES
        (#{productName,jdbcType=VARCHAR},
        #{productPrice,jdbcType=DECIMAL},
        #{productStock,jdbcType=INTEGER},
        #{productLimit,jdbcType=INTEGER},
        #{productImageUrl,jdbcType=VARCHAR})
        <!-- MyBatis 自动获取自增主键 -->
        <selectKey keyProperty="productId" order="AFTER" resultType="java.lang.Integer">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>

</mapper>